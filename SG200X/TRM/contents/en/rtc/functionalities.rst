Function description
--------------------

The RTC is an independently powered constant current module in the chip. When the RTC is powered on for the first time, the internal POR module generates a low-level pulse, and the 32KHz oscillator starts to oscillate. The POR low level maintenance time is greater than 13 clock(32KHz) cycles, and the RTC enters the initial state. When the state machine detects that the battery voltage is in a normal state, it starts to complete the chip power-on process according to the default value sequence and releases the system reset signal. After the software is powered on for the first time, it is necessary to initialize the RTC and configure the initial counting value. When the system is to be shut down or enter sleep mode, the system control register (RTC_CTRL) can be configured to trigger the RTC state machine to complete the chip power-off process according to the configuration sequence.

When the chip is in power-off shutdown or sleep state, it will continue to work as long as the RTC power supply is maintained to save necessary software code or user data in SRAM and information registers (RTC_INFO0 ~ RTC_INFO3, RTC_NOPOR_INFO0 ~ RTC_NOPOR_INFO3); the counter will continue to count. At the same time, it will also detect whether the button triggers the chip to turn on or wake up from sleep. When the trigger is received, the state machine will complete the chip power-on process according to the configured timing and release the system reset signal. After the processor core is restarted, the software can determine the chip status by reading back the contents previously written to the information register. The RTC also provides two status registers (RTC_ST_ON_REASON, RTC_ST_OFF_REASON) to record the previous power-off or power-on of the chip respectively. As well as the trigger conditions for reset, and provide more detailed content, such as whether unexpected events have occurred: forced reset, chip overheating, or battery/power supply loss, etc. In addition, when the RTC receives the Watchdog, it will trigger the state machine to send out a system reset signal according to the configured timing to restart the chip.

The RTC's counting clock uses a 32KHz clock and runs based on a 32-bit adding counter to provide second counting. The initial counting value is loaded from the register RTC_SET_SEC_CNTR_VALUE. The software can read back the second value through the register RTC_SEC_CNTR_VALUE and convert it into the specific year, month, day, hour, and minute.

The 32KHz clock and second pulse period can be calibrated through the software process, or the hardware module can be turned on to perform automatic calibration periodically.

Software can enable Alarm by configuring the 32-bit register RTC_ALARM_TIME and writing 1 to RTC_ALARM_ENABLE. When the second count value RTC_SEC_CNTR_VALUE is incremented to be equal to the RTC_ALARM_TIME value, the RTC will generate an alarm interrupt. The interrupt status will remain until 0 is written to RTC_ALARM_ENABLE.

In addition, the RTC provides battery low-voltage detection. When the battery voltage is lower than a certain level, the RTC will generate an interrupt. After the software receives the low-voltage interrupt, it can immediately execute the shutdown program and trigger the RTC to complete the power-off process to prevent abnormal errors in the system.